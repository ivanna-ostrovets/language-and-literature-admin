<h1 *ngIf="id">Редагувати тест</h1>
<h1 *ngIf="!id">Додати тест</h1>

<form novalidate
      #createtestform="ngForm"
      (ngSubmit)="submit(createtestform)"
      class="margin-top">

  <md-input-container class="block margin-bottom">
    <input mdInput
           required
           type="number"
           name="tasksQuantity"
           placeholder="Кількість запитань в тесті"
           min="1"
           [ngModel]="test.questions.length"
           (ngModelChange)="onQuestionsQuantityChange($event)">
  </md-input-container>

  <div *ngIf="test.questions.length > 0">
    <md-select required
               name="subject"
               class="block margin-bottom"
               placeholder="Предмет"
               [(ngModel)]="test.subject"
               (ngModelChange)="onSubjectChange($event)">
      <md-option *ngFor="let subject of subjects" [value]="subject._id">
        {{ subject.name }}
      </md-option>
    </md-select>

    <md-select required
               name="category"
               class="block margin-bottom"
               placeholder="Категорія"
               [(ngModel)]="test.category">
      <md-option *ngFor="let category of categories" [value]="category._id">
        {{ category.name }}
      </md-option>
    </md-select>

    <md-tab-group>
      <md-tab *ngFor="let number of getNumbersRange(test.questions.length); let i=index"
              [label]="i + 1">
        <md-input-container class="block margin-bottom question-title">
          <textarea mdInput
                    required
                    [name]="'task' + i"
                    placeholder="Завдання"
                    [(ngModel)]="test.questions[i].question">
          </textarea>
        </md-input-container>

        <div>
          <input type="file"
                 hidden
                 [id]="'image' + i"
                 (change)="uploadImage($event, i)"
                 accept="image/*">

          <button md-raised-button
                  (click)="clickOnElement('#image' + i)">
            Додати зображення
          </button>

          <md-input-container class="margin-bottom"
                              *ngIf="test.questions[i].img?.name">
            <input mdInput
                   disabled
                   [value]="test.questions[i].img?.name">
          </md-input-container>
        </div>

        <md-slide-toggle class="block slider-margin-bottom"
                         [name]="'matching' + i"
                         [(ngModel)]="test.questions[i].matchingQuestion">
          Завдання на відповідність
        </md-slide-toggle>

        <md-input-container class="block margin-bottom">
          <input mdInput
                 required
                 type="number"
                 [name]="'answersQuantity' + i"
                 placeholder="Кількість відповідей"
                 min="1"
                 [ngModel]="test.questions[i].answers.length"
                 (ngModelChange)="onAnswersQuantityChange($event, i)">
        </md-input-container>

        <div *ngIf="!test.questions[i].matchingQuestion">
          <div class="margin-bottom">
            <md-input-container class="block"
                                *ngFor="let number of getNumbersRange(test.questions[i].answers.length)">
            <textarea mdInput
                      required
                      [name]="'answer_' + number + '_' + i"
                      [placeholder]="'Відповідь ' + (number + 1)"
                      [(ngModel)]="test.questions[i].answers[number].text">
            </textarea>
            </md-input-container>
          </div>

          <div *ngIf="test.questions[i].answers.length" class="margin-bottom">
            <p class="label">Правильна відповідь</p>

            <md-radio-group required
                            name="rightAnswer"
                            *ngFor="let number of getNumbersRange(test.questions[i].answers.length)"
                            [(ngModel)]="test.questions[i].answers[number].correct">
              <md-radio-button [value]="number"
                               class="block answers-radio">
                {{ number + 1 }}
              </md-radio-button>
            </md-radio-group>
          </div>
        </div>

        <div *ngIf="test.questions[i].matchingQuestion">
          <md-input-container class="block margin-bottom">
            <input mdInput
                   required
                   type="number"
                   [name]="'numbersQuantity' + i"
                   placeholder="Кількість відповідей (1 - x)"
                   min="1"
                   [max]="test.questions[i].answers.length"
                   [value]="test.questions[i].answers.length"
                   [(ngModel)]="test.questions[i].numberedAnswersQuantity">
          </md-input-container>

          <md-input-container class="block margin-bottom">
            <input mdInput
                   required
                   type="number"
                   [name]="'lettersQuantity' + i"
                   placeholder="Кількість відповідей (A - Я)"
                   min="1"
                   [max]="test.questions[i].answers.length"
                   [value]="test.questions[i].answers.length"
                   [(ngModel)]="test.questions[i].letteredAnswersQuantity">
          </md-input-container>
        </div>

        <table class="answers-table margin-bottom"
               *ngIf="test.questions[i].matchingQuestion && test.questions[i].answers.length">
          <thead>
            <tr>
              <th>
                <md-input-container class="block">
                  <input mdInput
                         required
                         [name]="'answersTableTitle0_' + i"
                         placeholder="Заголовок"
                         [(ngModel)]="test.questions[i].tableTitles[0].title">
                </md-input-container>
              </th>
              <th>
                <md-input-container class="block">
                  <input mdInput
                         required
                         [name]="'answersTableTitle1_' + i"
                         placeholder="Заголовок"
                         [(ngModel)]="test.questions[i].tableTitles[1].title">
                </md-input-container>
              </th>
            </tr>
          </thead>

          <tbody>
            <tr *ngFor="let number of getNumbersRange(test.questions[i].answers.length)">
              <td>
                <md-input-container class="block">
                  <input mdInput
                         [name]="'answersNumbers' + number + '_' + i"
                         [placeholder]="'Варіант ' + getNumber(number, 0, false)"
                         [disabled]="test.questions[i].numberedAnswersQuantity < number + 1"
                         [(ngModel)]="test.questions[i].table[number][0].column">
                </md-input-container>
              </td>
              <td>
                <md-input-container class="block">
                  <input mdInput
                         [name]="'answersLetters' + number + '_' + i"
                         [placeholder]="'Варіант ' + getNumber(number, 1, false)"
                         [disabled]="test.questions[i].letteredAnswersQuantity < number + 1"
                         [(ngModel)]="test.questions[i].table[number][1].column">
                </md-input-container>
              </td>
            </tr>
          </tbody>
        </table>

        <div class="margin-bottom" *ngIf="test.questions[i].matchingQuestion">
          <p>Правильні відповіді</p>

          <table class="inputs-answers-table">
            <thead>
              <tr>
                <th></th>
                <th *ngFor="let number of getNumbersRange(test.questions[i].letteredAnswersQuantity)">
                  {{ getNumber(number, 1, false) }}
                </th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let number of getNumbersRange(test.questions[i].numberedAnswersQuantity)">
                <td class="number-label bold">{{ number + 1 }}</td>

                <td *ngFor="let num of getNumbersRange(test.questions[i].letteredAnswersQuantity)"
                    [(ngModel)]="test.questions[i].answers[number].text">
                  <md-radio-group required
                                  [name]="'complex_' + number"
                                  [(ngModel)]="test.questions[i].answers[number].correct">
                    <md-radio-button [value]="num + 1">
                    </md-radio-button>
                  </md-radio-group>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </md-tab>
    </md-tab-group>

    <div class="block center-align">
      <button type="button"
              md-raised-button
              (click)="cancel()">
        Назад
      </button>

      <button type="button"
              *ngIf="id"
              md-raised-button
              (click)="undoChanges()">
        Відмінити зміни
      </button>

      <button md-raised-button
              [disabled]="!createtestform.form.valid">
        <span *ngIf="id">Оновити</span>
        <span *ngIf="!id">Додати</span>
      </button>
    </div>
  </div>
</form>
